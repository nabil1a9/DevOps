<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IUniversiteServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">kaddemProject</a> &gt; <a href="index.source.html" class="el_package">tn.esprit.kaddemproject.services</a> &gt; <span class="el_source">IUniversiteServiceImpl.java</span></div><h1>IUniversiteServiceImpl.java</h1><pre class="source lang-java linenums">package tn.esprit.kaddemproject.services;

import lombok.AllArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import tn.esprit.kaddemproject.entities.*;
import tn.esprit.kaddemproject.generic.IGenericServiceImp;
import tn.esprit.kaddemproject.repositories.ContratRepository;
import tn.esprit.kaddemproject.repositories.DepartementRepository;
import tn.esprit.kaddemproject.util.HelperClass;

import java.time.LocalDate;
import java.time.temporal.ChronoUnit;
import java.util.*;
import java.util.stream.Collectors;

@Service
<span class="nc" id="L19">@Slf4j</span>
<span class="nc" id="L20">@AllArgsConstructor</span>
public class IUniversiteServiceImpl extends IGenericServiceImp&lt;Universite,Integer&gt; implements IUniversiteService{

    private final ContratRepository contratRepository;
    private final IDepartementServiceImpl departementService;

    @Override
    public void assignUniversiteToDepartement(Integer idUniversite, Integer idDepartement) {
<span class="nc" id="L28">        Universite universite = this.retrieveById(idUniversite);</span>
<span class="nc" id="L29">        Departement departement = departementService.retrieveById(idDepartement);</span>
<span class="nc bnc" id="L30" title="All 4 branches missed.">        if (universite!= null &amp;&amp; departement !=null){</span>
<span class="nc" id="L31">            universite.getDepartements().add(departement);</span>
        }
<span class="nc" id="L33">    }</span>

    @Override
    public List&lt;Departement&gt; retrieveDepartementsByUniversite(Integer idUniversite) {
<span class="nc" id="L37">        Universite universite = this.retrieveById(idUniversite);</span>
<span class="nc bnc" id="L38" title="All 2 branches missed.">        return universite!=null ? universite.getDepartements(): null;</span>
    }

    public List&lt;Contrat&gt; getContractsByDepartement(Departement departement) {
<span class="nc" id="L42">       return contratRepository.findByArchiveIsFalseAndEtudiantDepartement(departement);</span>
    }


    @Override
    public Map&lt;Specialite, Float&gt; getMontantContartEntreDeuxDate(int idUniv, LocalDate startDate, LocalDate endDate) {

        // get all active contracts between the start and end date
<span class="nc" id="L50">        List&lt;Departement&gt; departements = this.retrieveDepartementsByUniversite(idUniv);</span>
<span class="nc" id="L51">        List&lt;Contrat&gt; contrats = departements.stream()</span>
<span class="nc" id="L52">                .map(departement -&gt; this.getContractsByDepartement(departement))</span>
<span class="nc" id="L53">                .flatMap(List::stream)</span>
<span class="nc bnc" id="L54" title="All 4 branches missed.">                .filter(contrat -&gt; contrat.getArchive().equals(false) &amp;&amp; isContractBetween(contrat,startDate,endDate))</span>
<span class="nc" id="L55">                .collect(Collectors.toList());</span>

        // get price per sepcialite
<span class="nc" id="L58">        Map&lt;Specialite, Float&gt; map = new HashMap&lt;Specialite, Float&gt;();</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (contrats!= null){</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">            for (Specialite specialite : Specialite.values()) {</span>
<span class="nc" id="L61">                float price = contrats.stream()</span>
<span class="nc" id="L62">                        .filter(contrat -&gt; contrat.getSpecialite().equals(specialite))</span>
<span class="nc" id="L63">                        .map(contrat -&gt; getMontantContract(contrat,startDate,endDate))</span>
<span class="nc" id="L64">                        .collect(Collectors.summarizingLong(Long::longValue))</span>
<span class="nc" id="L65">                        .getSum();</span>

<span class="nc" id="L67">                map.put(specialite,price);</span>
            }
        }

<span class="nc" id="L71">        return map;</span>
    }

    public Boolean isContractBetween(Contrat contrat, LocalDate startDate, LocalDate endDate) {

        // java.util.Date before&amp;after
<span class="nc bnc" id="L77" title="All 4 branches missed.">        if(contrat.getDateDebutContrat().isAfter(startDate) &amp;&amp; contrat.getDateFinContrat().isBefore(endDate)</span>
<span class="nc bnc" id="L78" title="All 4 branches missed.">                || contrat.getDateFinContrat().isAfter(startDate) &amp;&amp; contrat.getDateFinContrat().isBefore(endDate)</span>
<span class="nc bnc" id="L79" title="All 4 branches missed.">                || contrat.getDateDebutContrat().isBefore(startDate) &amp;&amp; contrat.getDateFinContrat().isAfter(endDate) ){</span>
<span class="nc" id="L80">            return true;</span>
        }
<span class="nc" id="L82">        return false;</span>
    }



    public long getMontantContract(Contrat contrat, LocalDate startDate, LocalDate endDate){

<span class="nc" id="L89">        long nbJoursContrat = ChronoUnit.DAYS.between(contrat.getDateDebutContrat(), contrat.getDateFinContrat());</span>
<span class="nc" id="L90">        long nbJoursBetweenDebutContratAndStartDate = ChronoUnit.DAYS.between(startDate,contrat.getDateDebutContrat());</span>
<span class="nc" id="L91">        long nbJoursBetweenFinContratAndEndDate = ChronoUnit.DAYS.between(contrat.getDateFinContrat(),endDate);</span>

<span class="nc bnc" id="L93" title="All 2 branches missed.">        if(nbJoursBetweenDebutContratAndStartDate&lt;0) nbJoursContrat -= Math.abs(nbJoursBetweenDebutContratAndStartDate);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        if(nbJoursBetweenFinContratAndEndDate&lt;0) nbJoursContrat -= Math.abs(nbJoursBetweenFinContratAndEndDate);</span>

<span class="nc bnc" id="L96" title="All 2 branches missed.">        return nbJoursContrat&gt;0 ? contrat.getMontantContrat() * nbJoursContrat/30 : 0;</span>

    }

    public Map&lt;Specialite, Float&gt; getMontantContartEntreDeuxDate2(int idUniv, LocalDate startDate, LocalDate endDate) {

        // 1- Get all active contracts between the start and end date

<span class="nc" id="L104">        List&lt;Departement&gt; departements = this.retrieveDepartementsByUniversite(idUniv);</span>

        // 1.1- get all active contracts by id university &lt;&lt;idUniv&gt;&gt;
<span class="nc" id="L107">        List&lt;Contrat&gt; contrats = new ArrayList&lt;Contrat&gt;();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">        for (Departement departement : departements) {</span>
<span class="nc" id="L109">                contrats.addAll(contratRepository.findByArchiveIsFalseAndEtudiantDepartement(departement));</span>
<span class="nc" id="L110">        }</span>

        // 1.2- keep only contracts between the start and end Date
<span class="nc bnc" id="L113" title="All 2 branches missed.">        for (Contrat contrat: contrats) {</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">            if(isContractBetween(contrat,startDate,endDate) != true){</span>
<span class="nc" id="L115">                contrats.remove(contrat);</span>
            }
<span class="nc" id="L117">        }</span>

     /*   // using java stream: this bloc replaces the bloc from ligne 98 to 109
        List&lt;Contrat&gt; contrats1 = departements.stream()
                .map(departement -&gt; this.getContractsByDepartement(departement))
                .flatMap(List::stream)
                .filter(contrat -&gt; contrat.getArchive().equals(false) &amp;&amp; isContractBetween(contrat,startDate,endDate))
                .collect(Collectors.toList());
        */


        // 2- Get price per sepcialite
<span class="nc" id="L129">        Map&lt;Specialite, Float&gt; map = new HashMap&lt;Specialite, Float&gt;();</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (contrats!= null){</span>

<span class="nc bnc" id="L132" title="All 2 branches missed.">            for (Specialite specialite : Specialite.values()) {</span>
<span class="nc" id="L133">                float pricePerSpecialite = 0;</span>

<span class="nc bnc" id="L135" title="All 2 branches missed.">                for (Contrat contrat: contrats) {</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">                    if(contrat.getSpecialite().equals(specialite)){</span>
<span class="nc" id="L137">                        pricePerSpecialite += getMontantContract(contrat,startDate,endDate);</span>
                    }
<span class="nc" id="L139">                }</span>



                // using java stream: replaces from ligne 127 to 131
<span class="nc" id="L144">                 pricePerSpecialite = contrats.stream()</span>
<span class="nc" id="L145">                        .filter(contrat -&gt; contrat.getSpecialite().equals(specialite))</span>
<span class="nc" id="L146">                        .map(contrat -&gt; getMontantContract(contrat,startDate,endDate))</span>
<span class="nc" id="L147">                        .collect(Collectors.summarizingLong(Long::longValue))</span>
<span class="nc" id="L148">                        .getSum();</span>

<span class="nc" id="L150">                map.put(specialite,pricePerSpecialite);</span>
            }
        }

<span class="nc" id="L154">        return map;</span>
    }



}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>